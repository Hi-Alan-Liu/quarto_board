<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<title>Quarto æ¡ŒéŠ AI ç‰ˆæœ¬</title>

<link rel="icon" type="image/png" href="icon.png">

<meta name="description" content="Quarto æ¡ŒéŠ AI ç‰ˆæœ¬">
<meta name="author" content="Your Name">
<meta property="og:title" content="Quarto æ¡ŒéŠ AI ç‰ˆæœ¬">
<meta property="og:description" content="ä»¥ç´” HTML / CSS / JS è£½ä½œçš„ Quarto æ¡ŒéŠ AI å°æˆ°ç‰ˆæœ¬">
<meta property="og:image" content="icon.png">
<meta property="og:type" content="website">
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<style>
:root{
  --bg-top:#fff8f1;
  --bg-bottom:#f3e6d8;
  --panel:#ffffff;
  --board:#fff1dc;
  --cell:#ffe6c9;
  --pink:#ff7ab6;
  --blue:#6bb7ff;
  --text:#5a4632;
  --accent:#ffb703;
  --overlay:rgba(0,0,0,.4);
}

body{
  margin:0;
  background:linear-gradient(180deg,var(--bg-top),var(--bg-bottom));
  font-family:"Noto Sans TC","Microsoft JhengHei",system-ui;
  color:var(--text);
}

header{
  padding:14px 20px;
  font-weight:900;
  background:var(--bg-top);
}

main{
  max-width:1100px;
  margin:auto;
  padding:16px;
  display:grid;
  grid-template-columns:1.1fr .9fr;
  gap:16px;
}
@media(max-width:900px){main{grid-template-columns:1fr}}

.panel{
  background:var(--panel);
  border-radius:20px;
  padding:16px;
  box-shadow:0 8px 24px rgba(0,0,0,.06);
}

.board{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:12px;
  padding:14px;
  background:var(--board);
  border-radius:18px;
}

.cell{
  aspect-ratio:1/1;
  border-radius:16px;
  background:var(--cell);
  display:flex;
  align-items:center;
  justify-content:center;
}
.cell.filled{cursor:default}

.cell.last-move{
  outline:4px solid var(--accent);
  box-shadow:0 0 0 6px rgba(255,183,3,.35);
}

.pieces{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:12px;
}

.pieceBtn{
  aspect-ratio:1/1;
  border-radius:16px;
  background:#fff;
  box-shadow:0 6px 12px rgba(0,0,0,.12);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}
.pieceBtn.used{opacity:.3;cursor:not-allowed}
.pieceBtn.selected{
  outline:4px solid var(--accent);
  box-shadow:0 0 0 6px rgba(255,183,3,.4);
}

.resetBtn{
  margin-top:16px;
  width:100%;
  padding:12px;
  border:none;
  border-radius:16px;
  background:var(--accent);
  font-weight:900;
  cursor:pointer;
}

.status{
  margin-top:12px;
  padding:12px;
  border-radius:14px;
  background:var(--bg-top);
}

.overlay{
  position:fixed;
  inset:0;
  background:var(--overlay);
  display:none;
  align-items:center;
  justify-content:center;
}
.overlay.show{display:flex}

.modal{
  background:#fff;
  border-radius:24px;
  padding:24px;
  width:min(90%,360px);
  text-align:center;
}
.modal button{
  margin-top:16px;
  padding:10px 24px;
  border:none;
  border-radius:16px;
  background:var(--accent);
  font-weight:900;
}
</style>
</head>

<body>
<header>Quartoï½œå¯æ„› 2.5D ç‰ˆï¼ˆä½  vs AIï¼‰</header>

<main>
  <section class="panel">
    <div class="board" id="board"></div>
    <div class="status" id="status"></div>
  </section>

  <section class="panel">
    <h3>æ£‹å­</h3>
    <div class="pieces" id="pieces"></div>
    <button class="resetBtn" onclick="resetGame()">å†ä¾†ä¸€å±€</button>
  </section>
</main>

<div class="overlay" id="overlay">
  <div class="modal">
    <h2 id="modalTitle"></h2>
    <p id="modalDesc"></p>
    <button onclick="overlay.classList.remove('show')">OK!</button>
  </div>
</div>

<script>
const pieces=[...Array(16)].map((_,i)=>({
  id:i,color:(i>>3)&1,height:(i>>2)&1,shape:(i>>1)&1,hollow:i&1
}));

let board=Array(16).fill(null);
let used=Array(16).fill(false);
let phase=0,selected=null,gameOver=false;
let lastMoveIndex=null;

const boardEl=document.getElementById("board");
const piecesEl=document.getElementById("pieces");
const statusEl=document.getElementById("status");
const overlay=document.getElementById("overlay");
const modalTitle=document.getElementById("modalTitle");
const modalDesc=document.getElementById("modalDesc");

function pieceSVG(p, size = 56) {
  const topColor  = p.color ? "#6bb7ff" : "#ff7ab6";
  const bodyColor = p.color ? "#9fd0ff" : "#ffb2d6";
  const sideDark  = p.color ? "#3a6fa8" : "#d15b93";
  const sideLight = p.color ? "#8fc3ff" : "#ff9fc9";

  /* =========================
     åœ“æŸ±ï¼ˆCylinderï¼‰
     ========================= */
  if (p.shape === 0) {
    const h = p.height ? 64 : 30;
    const cx = 50;
    const rx = 28;
    const ry = 10;
    const topY = 26;
    const bottomY = topY + h;

    return `
<svg width="${size}" height="${size}" viewBox="0 0 100 100">
  <!-- åœ“æŸ±èº«é«” -->
  <path
    fill="${bodyColor}"
    d="
      M ${cx - rx},${topY}
      A ${rx},${ry} 0 0 0 ${cx + rx},${topY}
      L ${cx + rx},${bottomY}
      A ${rx},${ry} 0 0 1 ${cx - rx},${bottomY}
      Z
    "
  />

  <!-- é ‚é¢ -->
  <path
    fill="${topColor}"
    d="
      M ${cx - rx},${topY}
      A ${rx},${ry} 0 0 1 ${cx + rx},${topY}
      A ${rx},${ry} 0 0 1 ${cx - rx},${topY}
      Z
    "
  />

  <!-- ä¸­ç©º -->
  ${
    p.hollow
      ? `<path
          fill="#ffffff"
          d="
            M ${cx - 16},${topY}
            A 16,7 0 0 1 ${cx + 16},${topY}
            A 16,7 0 0 1 ${cx - 16},${topY}
            Z
          "
        />`
      : ""
  }
</svg>`;
  }

  /* =========================
     ç«‹æ–¹é«”ï¼ˆCuboidï¼‰
     ========================= */
  const HEIGHT = p.height ? 52 : 22;
  const TOP_Y = 24;
  const BASE_Y = TOP_Y + HEIGHT;

  return `
<svg width="${size}" height="${size}" viewBox="0 0 100 80">
  <!-- é ‚é¢ -->
  <path
    fill="${topColor}"
    d="
      M 20 ${TOP_Y}
      L 50 ${TOP_Y - 14}
      L 80 ${TOP_Y}
      L 50 ${TOP_Y + 14}
      Z
    "
  />

  <!-- å·¦å´é¢ -->
  <path
    fill="${sideDark}"
    d="
      M 20 ${TOP_Y}
      L 50 ${TOP_Y + 14}
      L 50 ${BASE_Y + 14}
      L 20 ${BASE_Y}
      Z
    "
  />

  <!-- å³å´é¢ -->
  <path
    fill="${sideLight}"
    d="
      M 50 ${TOP_Y + 14}
      L 80 ${TOP_Y}
      L 80 ${BASE_Y}
      L 50 ${BASE_Y + 14}
      Z
    "
  />

  <!-- ä¸­ç©º -->
  ${
    p.hollow
      ? `<path
          fill="#ffffff"
          d="
            M 50 ${TOP_Y - 6}
            L 62 ${TOP_Y}
            L 50 ${TOP_Y + 6}
            L 38 ${TOP_Y}
            Z
          "
        />`
      : ""
  }
</svg>`;
}

function render(){
  boardEl.innerHTML="";
  board.forEach((pid,i)=>{
    const c=document.createElement("div");
    c.className="cell"+(pid!==null?" filled":"")+(i===lastMoveIndex?" last-move":"");
    if(pid!==null)c.innerHTML=pieceSVG(pieces[pid]);
    c.onclick=()=>onBoard(i);
    boardEl.appendChild(c);
  });

  piecesEl.innerHTML="";
  pieces.forEach(p=>{
    const d=document.createElement("div");
    d.className="pieceBtn"+(used[p.id]?" used":"")+(p.id===selected?" selected":"");
    d.innerHTML=pieceSVG(p);
    d.onclick=()=>onPiece(p.id);
    piecesEl.appendChild(d);
  });
}

function onPiece(id){
  if(gameOver||used[id]||phase!==0)return;
  selected=id;phase=1;
  statusEl.textContent="AI æ­£åœ¨æ”¾ç½®ä½ é¸çš„æ£‹å­â€¦";
  setTimeout(aiPlace,400);
  render();
}

function onBoard(i){
  if(gameOver||phase!==3||board[i]!=null)return;
  board[i]=selected;used[selected]=true;
  lastMoveIndex=i;selected=null;
  render();
  if(checkWin("ä½ "))return;
  phase=0;statusEl.textContent="è«‹é¸ä¸€é¡†æ£‹å­çµ¦ AI";
}

function aiPlace(){
  const empty=board.map((v,i)=>v===null?i:null).filter(v=>v!=null);

  // 1ï¸âƒ£ AI èƒ½ç›´æ¥è´ï¼Ÿ
  for(const i of empty){
    if(wouldWin(board,i,selected)){
      placeAt(i);
      return;
    }
  }

  // 2ï¸âƒ£ é¿å…è®“ç©å®¶ä¸‹å›åˆå¿…å‹çš„ä½ç½®
  const safe=[];
  for(const i of empty){
    const test=[...board];
    test[i]=selected;

    const opponentPieces=pieces.filter(p=>!used[p.id] && p.id!==selected);
    let danger=false;

    for(const p of opponentPieces){
      const empties=test.map((v,j)=>v===null?j:null).filter(v=>v!=null);
      for(const e of empties){
        if(wouldWin(test,e,p.id)){
          danger=true;
          break;
        }
      }
      if(danger)break;
    }
    if(!danger) safe.push(i);
  }

  const target=(safe.length?safe:empty)[Math.random()* (safe.length||empty.length) |0];
  placeAt(target);
}

function placeAt(i){
  board[i]=selected;
  used[selected]=true;
  lastMoveIndex=i;
  selected=null;

  render();

  if(checkWin("AI"))return;
  phase=2;
  setTimeout(aiSelect,300);
}

function aiSelect(){
  const candidates=pieces.filter(p=>!used[p.id]);

  const safe=candidates.filter(p=>{
    const empties=board.map((v,i)=>v===null?i:null).filter(v=>v!=null);
    return !empties.some(i=>wouldWin(board,i,p.id));
  });

  function score(p){
    let s=0;
    ["color","height","shape","hollow"].forEach(a=>{
      const values=board
        .filter(v=>v!==null)
        .map(id=>pieces[id][a]);
      if(values.includes(p[a])) s++;
    });
    return s;
  }

  const pool=safe.length?safe:candidates;
  pool.sort((a,b)=>score(b)-score(a));

  selected=pool[0].id;
  phase=3;
  statusEl.textContent="è«‹æŠŠå³å´è¢«æ¡†èµ·ä¾†çš„æ£‹å­æ”¾ä¸Šæ£‹ç›¤";
  render();
}

function simulateWin(testBoard){
  const lines=[
    [0,1,2,3],[4,5,6,7],[8,9,10,11],[12,13,14,15],
    [0,4,8,12],[1,5,9,13],[2,6,10,14],[3,7,11,15],
    [0,5,10,15],[3,6,9,12]
  ];
  const attrs=["color","height","shape","hollow"];

  for(const l of lines){
    const ids=l.map(i=>testBoard[i]);
    if(ids.some(v=>v===null))continue;
    const ps=ids.map(id=>pieces[id]);
    for(const a of attrs){
      if(ps.every(p=>p[a]===ps[0][a])) return true;
    }
  }
  return false;
}

function wouldWin(board, index, pieceId){
  const copy=[...board];
  copy[index]=pieceId;
  return simulateWin(copy);
}

function showModal(t,d){
  modalTitle.textContent=t;
  modalDesc.innerHTML=d;
  overlay.classList.add("show");
}

function checkWin(who){
  const lines = [
    [0,1,2,3,"ç¬¬1æ©«åˆ—"],[4,5,6,7,"ç¬¬2æ©«åˆ—"],
    [8,9,10,11,"ç¬¬3æ©«åˆ—"],[12,13,14,15,"ç¬¬4æ©«åˆ—"],
    [0,4,8,12,"ç¬¬1ç›´è¡Œ"],[1,5,9,13,"ç¬¬2ç›´è¡Œ"],
    [2,6,10,14,"ç¬¬3ç›´è¡Œ"],[3,7,11,15,"ç¬¬4ç›´è¡Œ"],
    [0,5,10,15,"å·¦ä¸Š â†’ å³ä¸‹"],[3,6,9,12,"å³ä¸Š â†’ å·¦ä¸‹"]
  ];

  const attrs = [
    ["color","é¡è‰²"],
    ["height","é«˜åº¦"],
    ["shape","å½¢ç‹€"],
    ["hollow","ç©ºå¿ƒ / å¯¦å¿ƒ"]
  ];

  for(const l of lines){
    const ids = l.slice(0,4).map(i => board[i]);
    if(ids.some(v => v === null)) continue;

    const ps = ids.map(id => pieces[id]);

    for(const [attr, name] of attrs){
      if(ps.every(p => p[attr] === ps[0][attr])){
        gameOver = true;

        winCells = l.slice(0,4);

        showModal(
          `${who} ç²å‹ ğŸ‰`,
          `
            <div style="line-height:1.7">
              <strong>ç²å‹å±¬æ€§ï¼š</strong>${name}<br>
              <strong>ç²å‹ä½ç½®ï¼š</strong>${l[4]}
            </div>
          `
        );

        render();
        return true;
      }
    }
  }

  if(used.every(v => v)){
    gameOver = true;
    showModal(
      "å¹³æ‰‹ ğŸ¤",
      "æ£‹å­å·²å…¨éƒ¨ç”¨å®Œï¼Œé›™æ–¹å‹¢å‡åŠ›æ•µï¼"
    );
    return true;
  }

  return false;
}

function resetGame(){
  overlay.classList.remove("show");
  board=Array(16).fill(null);
  used=Array(16).fill(false);
  phase=0;selected=null;gameOver=false;
  lastMoveIndex=null;
  statusEl.textContent="è«‹é¸ä¸€é¡†æ£‹å­çµ¦ AI";
  render();
}

statusEl.textContent="è«‹é¸ä¸€é¡†æ£‹å­çµ¦ AI";
render();
</script>
</body>
</html>

